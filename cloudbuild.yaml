steps:
  # 1️⃣ Install dependencies & run tests
  - name: python:3.10
    id: test
    entrypoint: bash
    env:
      - PYTHONPATH=.
    args:
      - -c
      - |
        pip install -r requirements.txt
        pytest

  # 2️⃣ Build Docker image
  - name: gcr.io/cloud-builders/docker
    id: docker-build
    args:
      - build
      - -t
      - asia-south1-docker.pkg.dev/theena-devops/theena-devops-repo/gcp-devops-app:$SHORT_SHA
      - .

  # 3️⃣ Trivy vulnerability scan
  - name: aquasec/trivy:0.49.1
    id: trivy-scan
    entrypoint: sh
    args:
      - -c
      - |
        trivy image \
          --severity HIGH,CRITICAL \
          --exit-code 0 \
          --format table \
          asia-south1-docker.pkg.dev/theena-devops/theena-devops-repo/gcp-devops-app:$SHORT_SHA

  # 4️⃣Push image to Artifact Registry
  - name: gcr.io/cloud-builders/docker
    id: docker-push
    args:
      - push
      - asia-south1-docker.pkg.dev/theena-devops/theena-devops-repo/gcp-devops-app:$SHORT_SHA


  #4️⃣5️⃣Fetch SonarQube token from Secret Manager
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: fetch-sonar-token
    entrypoint: bash
    args:
      - -c
      - |
        gcloud secrets versions access latest \
          --secret=sonarqube-token > /workspace/sonar_token.txt

  #6️⃣ Run SonarQube scan
  - name: sonarsource/sonar-scanner-cli
    id: sonar-scan
    entrypoint: bash
    args:
      - -c
      - |
        SONAR_TOKEN=$(cat /workspace/sonar_token.txt)

        sonar-scanner \
          -Dsonar.projectKey=gcp-devops \
          -Dsonar.projectName=gcp-devops \
          -Dsonar.projectBaseDir=/workspace \
          -Dsonar.sources=src \
          -Dsonar.tests=tests \
          -Dsonar.language=py \
          -Dsonar.python.version=3.10 \
          -Dsonar.scm.disabled=true \
          -Dsonar.userHome=/tmp \
          -Dsonar.working.directory=/tmp/.scannerwork \
          -Dsonar.host.url=http://10.10.2.2:9000 \
          -Dsonar.login=$$SONAR_TOKEN
options:
  logging: CLOUD_LOGGING_ONLY
  pool:
    name: projects/theena-devops/locations/asia-south1/workerPools/private-ci-pool
